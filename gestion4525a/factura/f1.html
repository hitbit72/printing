<!DOCTYPE html>
<html lang="es">
<!--
https://github.com/templid/email-templates/tree/main/templid-dynamic-templates
-->
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="Cache-Control" content="no-store, must-revalidate" />
  <meta http-equiv="cache-control" content="max-age=0" />
  <meta http-equiv="Pragma" content="no-cache" />
  <meta http-equiv="Expires" content="0" />
  <title>Factura</title>
  <link rel="stylesheet" href="css/style.css" type="text/css" media="all" />
</head>

<body>
  <div class="prPage">
    <div class="py-4">
      <div class="px-14 py-3">
        <table class="w-full border-collapse border-spacing-0">
          <tbody>
            <tr>
              <td class="w-full align-top">
                <div>
                  <img src="../img/logo01.png" class="h-17" />
                </div>
              </td>

              <td>
                <div class="text-sm">
                  <table class="border-collapse border-spacing-0">
                    <tbody>
                      <tr>
                        <td class="border-r pr-4">
                          <div>
                            <p class="whitespace-nowrap text-slate-500 text-right">Fecha</p>
                            <p id="fechaDoc" class="whitespace-nowrap font-bold text-main text-right">April 26, 2023</p>
                          </div>
                        </td>
                        <td class="pl-4">
                          <div>
                            <p class="whitespace-nowrap text-slate-500 text-right">Factura #</p>
                            <p id="prNumero" class="whitespace-nowrap font-bold text-main text-right">BRA-00335</p>
                          </div>
                        </td>
                      </tr>
                    </tbody>
                  </table>
                </div>
              </td>
            </tr>
          </tbody>
        </table>
      </div>

      <div class="bg-slate-100 px-14 py-3 text-sm">
        <table class="w-full border-collapse border-spacing-0">
          <tbody>
            <tr>
              <td class="w-1/2 align-top">
                <div id="empresa" class="text-sm text-neutral-600">
                  <p id="nEmpresa" class="font-bold">C/ Linares nº 38</p>
                  <p id="dEmpresa">23537 Bedmar (Jaén)<br>
                  664 07 06 41<br></p>
                </div>
              </td>
              <td class="w-1/2 align-top text-right">
                <div id="cliente" class="text-sm text-neutral-600">
                  <p id="nCliente" class="font-bold">Felipe Blanco Garcia</p>
                  <p id="dCliente">4000000N<br>
                  C/ Eguido San Sebastian, 2<br>
                  23530 Jimena - Jaén<br>
                  635 89 89 89<br>
                </div>
              </td>
            </tr>
          </tbody>
        </table>
      </div>

      <div class="px-12 py-5 text-sm text-neutral-700">
        <table id="pr01" class="w-full border-collapse border-spacing-0">
          <thead>
            <tr>
              <td class="border-b-2 border-main pb-3 pl-2 font-bold text-main">Producto / Descripción</td>
              <td class="border-b-2 border-main pb-3 pl-2 text-right font-bold text-main">Precio</td>
              <td class="border-b-2 border-main pb-3 pl-2 text-right font-bold text-main">Cant.</td>
              <td class="border-b-2 border-main pb-3 pl-2 pr-3 text-right font-bold text-main">Total</td>
            </tr>
          </thead>
          <tbody>
          </tbody>
          <tfoot>
            <!-- tr -->
              <!-- td colspan="7" -->
                <table class="w-full border-collapse border-spacing-0 mt-1">
                  <tbody>
                    <tr>
                      <td class="w-full"></td>
                      <td>
                        <table class="w-full border-collapse border-spacing-0">
                          <tbody>
                            <tr>
                              <td class="border-b p-2">
                                <div class="whitespace-nowrap text-slate-500">Subtotal:</div>
                              </td>
                              <td class="border-b p-2 text-right">
                                <div id="subtotal" class="whitespace-nowrap font-bold text-main">320,00</div>
                              </td>
                            </tr>
                            <tr>
                              <td class="p-2">
                                <div id="iva" class="whitespace-nowrap text-slate-500">IVA (21%):</div>
                              </td>
                              <td class="p-2 text-right">
                                <div id="taxes" class="whitespace-nowrap font-bold text-main">64,00</div>
                              </td>
                            </tr>
                            <tr>
                              <td class="bg-main p-2">
                                <div class="whitespace-nowrap font-bold text-white">Total:</div>
                              </td>
                              <td class="bg-main p-2 text-right">
                                <div id="total" class="whitespace-nowrap font-bold text-white">1384,00</div>
                              </td>
                            </tr>
                          </tbody>
                        </table>
                      </td>
                    </tr>
                  </tbody>
                </table>
              <!-- /td -->
            <!-- /tr -->
          </tfoot>
        </table>
      </div>

      <!--
      <div class="px-14 text-xs text-neutral-700">
        <p class="text-main font-bold">DETALLES DEL PAGO</p>
        <p>Banks of Banks</p>
        <p>Bank/Sort Code: 1234567</p>
        <p>Account Number: 123456678</p>
        <p>Payment Reference: BRA-00335</p>
      </div>
      -->

      <div class="px-14 py-4  text-neutral-700">
        <p class="text-main font-bold" id="footerTitle"></p>
        <p class="italic" id="footerText"></p>
      </div>

      <!--
        <footer class="fixed bottom-0 left-0 bg-slate-100 w-full text-neutral-600 text-center text-xs py-3">
          Carpintería Eugenio Romero Medina
          <span class="text-slate-300 px-2">|</span>
          cuadrosrural@hotmail.es
          <span class="text-slate-300 px-2">|</span>
          600 25 00 92
        </footer>
      -->
      </div>
    </div>

    <script>

      /** 
      *   Crea la url a la foto dentro de appsheets
      * 
      *   id = id de la aplicacion
      *   tabla = tabla donde se almacena la foto
      *   imagen = celda donde esta la imagen
      */
      function fotoURL(id, tabla, imagen){
        const ft = "https://www.appsheet.com/template/gettablefileurl?appName="+id+"&tableName="+tabla+"&fileName="+imagen;
        return ft;
      }

      /**
       * Formate numeros
       * n = numero
       */
      function fNum(n){
        const v = Intl.NumberFormat('es-ES', { 
          style: "currency",
          currency: "EUR",
          }).format(n);
          return v;
      }

      function trunc (x, posiciones = 2) {
        let numStr;
        let l = x.replace('.', ',');
        let i = l.indexOf(',');
        
        if (i >= 0){
          let dl = i+1;
          numStr = l.substr(0, dl + posiciones);
        }else{
          numStr=x+",00";
        }

        return numStr;
      }

      function addLine(id, datos){
      /**
       * Separador de datos: þ
       * Separador de linea: θ
       * [Concepto]&"þ"&[Cantidad]&"þ"&[Importe]&"þ"&[Total Linea]&"θ"
       */

        //get table body:
        const tbl = document.getElementById(id).getElementsByTagName('tbody')[0];
        const ln = datos.split('θ');

        for (let i = 0; i < ln.length; i++){
          let dt = ln[i].split('þ');
          if(dt[0]){
            tbl.insertRow().innerHTML = '<td class="border-b py-0 pl-2">'+dt[0]+'</td><td class="border-b py-0 pl-2 text-right">'+trunc(dt[1])+'</td><td class="border-b py-0 pl-2 text-right">'+trunc(dt[2])+'</td><td class="border-b py-0 pl-2 pr-3 text-right">'+trunc(dt[3])+'</td>';
          }
        }
      }

      /**
       * Formato salida de datos del cliente
       * [Nombre]&"þ"&[DNI]&"þ"&[Dirección]&"þ"&[CP]&"þ"&[Población]&"þ"&[Provincia]&"þ"&[Teléfono]
       */
      function fCliente(cl){
        let datos="";
        if (cl[1] != ""){ datos +=cl[1]+"<br>"; }
        if (cl[2] != ""){ datos +=cl[2]+"<br>"; }
        if (cl[3] != ""){ 
          datos +=cl[3]+" "+cl[4]; 
          if (cl[5] != ""){ datos +=" ("+cl[5]+")<br>"; } else { datos +="<br>"; }
        }else{
          datos +=cl[4];
          if (cl[5] != ""){ datos +=" ("+cl[5]+")<br>"; } else { datos +="<br>"; }
        }
        if (cl[6] != ""){ datos +=cl[6]; }

        return datos;
      }


      // Empezamos a buscar los parametros pasados al url
      const url = window.location.href;
      const paramsString = url.split("?")[1];
      const paramsArray = paramsString.split("&");
      const params = {};

      paramsArray.forEach(param => {
        const [key, value] = param.split("=");
        params[key] = value;
      });

      /**
       * Separador de datos: þ
       * Separador de linea: θ
       */

      const appid = params.idapp;                 // APP  ID
      let cliente = decodeURI(params.cliente);    // Linea con todos los datos del cliente
      const lineas = decodeURI(params.lineas);    // Lineas del presupuesto
      cliente = cliente.replaceAll('%2C',',');
      cliente = cliente.replaceAll('%2F','/');
      const dCliente = cliente.split("þ");
      
      let numDoc = decodeURI(params.numero);      // Numero del presupuesto
      numDoc = numDoc.replace('%2F','/');

      let fechaDoc = decodeURI(params.fecha);     // Fecha de presupuesto
      fechaDoc = fechaDoc.replaceAll('%2F','/');
      
      let fText = decodeURI(params.txtPie);

      document.getElementById("nCliente").innerHTML = dCliente[0];
      document.getElementById("dCliente").innerHTML = fCliente(dCliente);
      document.getElementById("prNumero").innerHTML = numDoc;
      document.getElementById("fechaDoc").innerHTML = fechaDoc;
      document.getElementById("iva").innerHTML = "IVA ("+params.iva+"%):";
      document.getElementById("subtotal").innerHTML = fNum(params.subtotal);
      document.getElementById("taxes").innerHTML = fNum(params.taxes);
      document.getElementById("total").innerHTML = fNum(params.total);
      if (fText.length > 0){
        fechaDoc = fechaDoc.replaceAll('%3A',':');
        document.getElementById("footerText").innerHTML = fText;
        document.getElementById("footerTitle").innerHTML = "Información:";
        
      }

      addLine("pr01", lineas);

      // Script para abrir la ventana de impresion
      window.onload = function(){
        window.print();
      };
    </script>

  </body>
</html>
